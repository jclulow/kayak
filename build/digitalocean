#!/bin/bash
#
# {{{ CDDL HEADER
#
# This file and its contents are supplied under the terms of the
# Common Development and Distribution License ("CDDL"), version 1.0.
# You may only use this file in accordance with the terms of version
# 1.0 of the CDDL.
#
# A full copy of the text of the CDDL should have accompanied this
# source. A copy of the CDDL is also available via the Internet at
# http://www.illumos.org/license/CDDL.
# }}}
#
# Copyright 2020 Oxide Computer Company
#

SRCDIR=`dirname $0`
[ ${SRCDIR:0:1} = "/" ] || SRCDIR=`pwd`/$SRCDIR

. $SRCDIR/../lib/hvm_help.sh

[ -z "$BUILDSEND_MP" ] && BUILDSEND_MP=/kayak_image

find_zfssend
[ ! -f $ZFSSEND ] && echo "ZFS Image ($ZFSSEND) missing" && exit

set -e

customise() {
    #
    # Enable DNS resolution without providing any resolver addresses.  Those
    # will be set from the metadata provided by the hypervisor.
    #
    log "...enabling DNS resolution"
    SetDNS

    log "...updating the image"
    pkg -R "$ALTROOT" update --deny-new-be

    #
    # XXX This should be an IPS package.
    #
    log "...installing metadata agent"
    cp /var/tmp/metadata.xml \
        "$ALTROOT/lib/svc/manifest/system/digitalocean.xml"
    cp /var/tmp/metadata \
        "$ALTROOT/usr/lib/digitalocean"
    chmod 0755 "$ALTROOT/usr/lib/digitalocean"

    #
    # Include rsync in the image so that it is easier to bootstrap other
    # configuration and image management systems in the guest via SSH.
    #
    log "...installing rsync"
    pkg -R "$ALTROOT" install network/rsync

    log "...enabling SSH with public key"
    mkdir "$ALTROOT/root/.ssh"
    sed -i -e 's%^PermitRootLogin.*%PermitRootLogin without-password%' \
        "$ALTROOT/etc/ssh/sshd_config"

    log "...decreasing boot delay"
    printf 'autoboot_delay=1\n' >> "$ALTROOT/boot/loader.conf.local"

    #
    # XXX Can we not just fix this before boxing it up?
    #
    log "...fixing rpool mount directory"
    Postboot 'zfs set mountpoint=/rpool rpool'
    Postboot 'rmdir /HVMdigitaloceanrpool || true'
}

HVM_Image_Init 2G rpool digitalocean omnios-r$VERSION
HVM_Image_Build "-fd -o ashift=12" $ZFSSEND omnios customise
HVM_Image_Finalise '' '' '' '' -nopatch -keeplofi

echo "Creating raw disk image"

raw="$BUILDSEND_MP/digitalocean-$VERSION.raw"
rm -f "$raw"
dd if="$HVMlofi" of="$raw" bs=2048
lofiadm -d "$HVMlofi"
zfs destroy -r "$HVMdataset"

rm -f "$raw.gz"
gzip --best "$raw"

# Vim hints
# vim:ts=4:sw=4:et:fdm=marker
